<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WayraLink</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
        }
        .view-transition {
            transition: opacity 0.5s ease-in-out;
        }
        .bubble-btn {
            position: relative;
            overflow: hidden;
        }
        .bubble-btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 5px;
            height: 5px;
            background: rgba(255, 255, 255, 0.5);
            opacity: 0;
            border-radius: 100%;
            transform: scale(1, 1) translate(-50%);
            transition: all 0.5s ease-out;
        }
        .bubble-btn:hover::after {
            transform: scale(200, 200) translate(-50%);
            opacity: 1;
        }
        .nav-btn.active {
            background-color: #2563eb;
            color: white;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .star-rating {
            display: inline-block;
        }
        .star-rating input {
            display: none;
        }
        .star-rating label {
            float: right;
            cursor: pointer;
            color: #ccc;
            transition: color 0.2s;
        }
        .star-rating label:before {
            content: '★';
            font-size: 2em;
        }
        .star-rating input:checked ~ label {
            color: #fcd34d;
        }
        .star-rating label:hover,
        .star-rating label:hover ~ label {
            color: #fcd34d;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center p-4">

    <!-- Navbar de navegación -->
    <nav class="w-full max-w-4xl bg-white rounded-xl shadow-lg p-4 mb-8 flex flex-col sm:flex-row justify-between items-center transition-all duration-300">
        <div class="text-center sm:text-left mb-4 sm:mb-0">
            <h1 class="text-2xl font-extrabold text-gray-900 leading-tight">WayraLink</h1>
        </div>
        <div class="flex flex-wrap justify-center sm:justify-end items-center space-x-2 sm:space-x-4 space-y-2 sm:space-y-0 w-full sm:w-auto">
            <button id="nav-services-btn" class="nav-btn bg-gray-200 text-gray-800 px-4 py-2 rounded-xl font-bold hover:bg-gray-300 transition duration-300 transform hover:scale-105">Servicios</button>
            <button id="nav-about-btn" class="nav-btn bg-gray-200 text-gray-800 px-4 py-2 rounded-xl font-bold hover:bg-gray-300 transition duration-300 transform hover:scale-105">Sobre Nosotros</button>
            <button id="nav-support-btn" class="nav-btn bg-gray-200 text-gray-800 px-4 py-2 rounded-xl font-bold hover:bg-gray-300 transition duration-300 transform hover:scale-105">Soporte</button>
            <button id="add-profile-btn" class="bg-blue-600 text-white px-4 py-2 rounded-xl font-bold shadow-lg hover:bg-blue-700 transition duration-300 transform hover:scale-105 bubble-btn">AGREGAR PERFIL</button>
            <button id="admin-panel-btn" class="bg-gray-500 text-white px-4 py-2 rounded-xl font-bold shadow-lg hover:bg-gray-600 transition duration-300 transform hover:scale-105 bubble-btn">ADMIN</button>
        </div>
        <div id="user-info-container" class="text-sm text-gray-500 w-full text-center mt-4 sm:mt-0 sm:w-auto sm:text-left">
            <span id="user-id-display">ID de usuario: Cargando...</span>
        </div>
    </nav>

    <!-- Contenedor de la vista principal que maneja los diferentes módulos -->
    <main id="main-content" class="w-full max-w-4xl">

        <!-- Vista de la lista de perfiles (pestaña 'Servicios') -->
        <section id="profiles-view" class="view-transition bg-white rounded-xl shadow-lg p-6 mb-8">
            <h2 class="text-2xl font-semibold mb-6 text-gray-800">Perfiles de proveedores</h2>
            <!-- Controles de búsqueda y filtro -->
            <div class="flex flex-col sm:flex-row gap-4 mb-6">
                <input type="text" id="search-input" placeholder="Buscar por nombre o servicio..." class="flex-1 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50">
                <select id="category-filter" class="rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50">
                    <option value="all">Todas las categorías</option>
                </select>
                <select id="subcategory-filter" class="rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50">
                    <option value="all">Todas las subcategorías</option>
                </select>
            </div>
            <div class="flex flex-col sm:flex-row gap-4 mb-6">
                 <select id="region-filter" class="flex-1 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50">
                    <option value="all">Todas las Regiones</option>
                </select>
                <select id="province-filter" class="flex-1 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50">
                    <option value="all">Todas las Provincias</option>
                </select>
                <select id="district-filter" class="flex-1 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50">
                    <option value="all">Todos los Distritos</option>
                </select>
            </div>
            
            <div id="loading-message" class="text-center text-gray-500 mb-4 hidden">
                <p>Cargando perfiles...</p>
            </div>
            <div id="profiles-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Los perfiles se insertarán aquí dinámicamente -->
            </div>
            <div id="no-profiles-message" class="hidden text-center text-gray-500 mt-8">
                <p>Aún no hay perfiles de servicio disponibles. ¡Sé el primero en ofrecer uno!</p>
            </div>
        </section>
        
        <!-- Vista del formulario para agregar un nuevo perfil -->
        <section id="add-profile-view" class="view-transition bg-white rounded-xl shadow-lg p-6 mb-8 hidden">
            <button id="back-to-profiles-btn" class="text-blue-600 hover:text-blue-800 transition duration-300 mb-4 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
                </svg>
                Volver a la lista
            </button>
            <h2 class="text-2xl font-semibold mb-2 text-gray-800">Promociona tus servicios</h2>
            <p class="text-gray-600 mb-6">Completa el formulario para que tu perfil aparezca en la lista.</p>
            
            <form id="add-profile-form" class="space-y-4">
                <div>
                    <label for="profile-name" class="block text-sm font-medium text-gray-700">Tu Nombre o Empresa</label>
                    <input type="text" id="profile-name" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50">
                </div>
                <div>
                    <label for="profile-category" class="block text-sm font-medium text-gray-700">Categoría del Servicio</label>
                    <select id="profile-category" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50">
                        <option value="">Selecciona una categoría...</option>
                    </select>
                </div>
                <div>
                    <label for="profile-subcategory" class="block text-sm font-medium text-gray-700">Subcategoría del Servicio</label>
                    <select id="profile-subcategory" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50">
                        <option value="">Selecciona una subcategoría...</option>
                    </select>
                </div>
                <div>
                    <div class="flex justify-between items-center">
                        <label for="profile-description" class="block text-sm font-medium text-gray-700">Descripción del servicio</label>
                        <button type="button" id="coherence-help-btn" class="text-xs text-blue-600 hover:text-blue-800 font-semibold transition duration-300 px-3 py-1 rounded-full border border-blue-600 hover:border-blue-800">
                            Revisar Coherencia ✨
                        </button>
                    </div>
                    <textarea id="profile-description" rows="3" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50"></textarea>
                </div>
                 <div>
                    <label class="block text-sm font-medium text-gray-700">Ubicación</label>
                    <select id="profile-region" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50">
                        <option value="">Selecciona una Región...</option>
                    </select>
                    <select id="profile-province" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50">
                        <option value="">Selecciona una Provincia...</option>
                    </select>
                    <select id="profile-district" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50">
                        <option value="">Selecciona un Distrito...</option>
                    </select>
                </div>
                <div>
                    <label for="profile-image" class="block text-sm font-medium text-gray-700">Imagen de tu servicio (Subir archivo)</label>
                    <input type="file" id="profile-image" accept="image/*" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
                    <div id="image-preview" class="mt-2 hidden">
                        <p class="text-xs text-gray-500">Vista previa:</p>
                        <img id="preview-image" src="#" alt="Vista previa de la imagen" class="mt-1 w-32 h-32 object-cover rounded-lg border border-gray-300">
                    </div>
                    <div id="upload-progress-container" class="w-full bg-gray-200 rounded-full h-2.5 mt-2 hidden">
                        <div id="upload-progress" class="bg-blue-600 h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                </div>
                <div>
                    <label for="profile-contact" class="block text-sm font-medium text-gray-700">Número de WhatsApp (ej. +51912345678)</label>
                    <input type="tel" id="profile-contact" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50">
                </div>
                <div class="flex justify-end space-x-4 mt-6">
                    <button type="submit" id="save-profile-btn" class="bg-green-600 text-white px-6 py-3 rounded-xl font-bold shadow-lg hover:bg-green-700 transition duration-300 transform hover:scale-105 bubble-btn">
                        Guardar Perfil
                    </button>
                </div>
            </form>
            <div id="saving-message" class="hidden text-center text-gray-600 mt-4 font-semibold">
                Guardando perfil, por favor espera...
            </div>
        </section>

        <!-- Vista del panel de administración -->
        <section id="admin-view" class="view-transition bg-white rounded-xl shadow-lg p-6 mb-8 hidden">
            <button id="back-to-profiles-from-admin-btn" class="text-blue-600 hover:text-blue-800 transition duration-300 mb-4 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
                </svg>
                Volver a la lista
            </button>
            <h2 class="text-2xl font-semibold mb-6 text-gray-800">Panel de Administración</h2>
            <div id="admin-profiles-list" class="space-y-4">
                <!-- Los perfiles se insertarán aquí para gestión del administrador -->
            </div>
            <div id="no-admin-profiles-message" class="hidden text-center text-gray-500 mt-8">
                <p>No hay perfiles para administrar.</p>
            </div>
        </section>

        <!-- Nueva vista "Sobre Nosotros" -->
        <section id="about-us-view" class="view-transition bg-white rounded-xl shadow-lg p-6 mb-8 hidden">
            <h2 class="text-2xl font-semibold mb-4 text-gray-800">Sobre WayraLink</h2>
            <p class="text-gray-600 leading-relaxed">
                WayraLink es una plataforma diseñada para conectar a la comunidad con servicios locales de manera fácil y segura.
                Nuestra misión es empoderar a los pequeños emprendedores y a los proveedores de servicios,
                ofreciéndoles un espacio visible para promocionar su trabajo. Al mismo tiempo,
                proporcionamos a los usuarios una herramienta confiable para encontrar lo que necesitan
                cerca de ellos.
            </p>
            <p class="text-gray-600 leading-relaxed mt-4">
                Creemos en el poder de la conexión local y en la construcción de una comunidad fuerte,
                basada en la confianza y el apoyo mutuo. ¡Únete a nuestra red y sé parte del cambio!
            </p>
        </section>

        <!-- Nueva vista "Soporte" -->
        <section id="support-view" class="view-transition bg-white rounded-xl shadow-lg p-6 mb-8 hidden">
            <h2 class="text-2xl font-semibold mb-4 text-gray-800">Soporte y Contacto</h2>
            <p class="text-gray-600 leading-relaxed mb-4">
                Si tienes alguna pregunta, sugerencia o necesitas ayuda, no dudes en contactarnos.
                Estamos aquí para asistirte.
            </p>
            <div class="space-y-4">
                <div>
                    <h3 class="font-bold text-lg text-gray-800">Preguntas Frecuentes (FAQ)</h3>
                    <p class="text-gray-600">En esta sección, podrás encontrar respuestas a las dudas más comunes sobre cómo usar la plataforma, agregar un perfil o reportar un problema.</p>
                </div>
                <div>
                    <h3 class="font-bold text-lg text-gray-800">Envía un Mensaje</h3>
                    <p class="text-gray-600">Para consultas específicas, puedes escribirnos directamente a nuestro correo: <a href="mailto:soporte@wayralink.com" class="text-blue-600 hover:underline">soporte@wayralink.com</a>.</p>
                </div>
            </div>
        </section>

    </main>

    <!-- Modal para mensajes y formularios -->
    <div id="modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-lg p-6 shadow-xl max-w-sm w-full">
            <h3 id="modal-title" class="text-xl font-bold mb-4"></h3>
            <p id="modal-message" class="text-gray-700 mb-6"></p>
            <div id="modal-content"></div>
            <div id="modal-buttons" class="flex justify-end space-x-2 mt-4">
                <button id="modal-cancel-btn" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg font-medium hover:bg-gray-300 transition duration-300">Cancelar</button>
                <button id="modal-ok-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-blue-700 transition duration-300">Aceptar</button>
            </div>
        </div>
    </div>

    <!-- Carga y configuración de Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, query, addDoc, doc, updateDoc, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth, userId = null;
        let storage;
        let allProfiles = [];
        
        // Datos de Perú (representativos)
        const peruLocations = {
            "Amazonas": {
                "Bagua": ["Bagua", "Aramango"],
                "Chachapoyas": ["Chachapoyas", "Asuncion", "Levanto"],
                "Utcubamba": ["Bagua Grande", "Cajaruro"]
            },
            "Áncash": {
                "Huaraz": ["Huaraz", "Independencia"],
                "Santa": ["Chimbote", "Coishco", "Nuevo Chimbote"]
            },
            "Apurímac": {
                "Abancay": ["Abancay", "Chacoche"],
                "Andahuaylas": ["Andahuaylas", "Talavera"]
            },
            "Arequipa": {
                "Arequipa": ["Arequipa", "Yanahuara", "Cayma", "Cerro Colorado"],
                "Islay": ["Mollendo", "Cocachacra"]
            },
            "Ayacucho": {
                "Huamanga": ["Ayacucho", "Carmen Alto", "San Juan Bautista"]
            },
            "Cajamarca": {
                "Cajamarca": ["Cajamarca", "Baños del Inca"],
                "Jaén": ["Jaén", "Bellavista"]
            },
            "Callao": {
                "Callao": ["Bellavista", "Callao", "Carmen de la Legua-Reynoso", "La Perla", "La Punta", "Ventanilla", "Mi Perú"]
            },
            "Cusco": {
                "Cusco": ["Cusco", "Wanchaq", "San Sebastián"],
                "Urubamba": ["Ollantaytambo", "Machu Picchu"]
            },
            "Huancavelica": {
                "Huancavelica": ["Huancavelica", "Acobambilla"]
            },
            "Huánuco": {
                "Huánuco": ["Huánuco", "Amarilis", "Pillco Marca"]
            },
            "Ica": {
                "Ica": ["Ica", "Parcona", "La Tinguiña"],
                "Chincha": ["Chincha Alta", "Grocio Prado"],
                "Pisco": ["Pisco", "Paracas"]
            },
            "Junín": {
                "Huancayo": ["Huancayo", "Chilca", "El Tambo"],
                "Jauja": ["Jauja", "Yauyos"]
            },
            "La Libertad": {
                "Trujillo": ["Trujillo", "Víctor Larco Herrera", "La Esperanza", "Florencia de Mora"],
                "Chepén": ["Chepén", "Pacanga"]
            },
            "Lambayeque": {
                "Chiclayo": ["Chiclayo", "La Victoria", "José Leonardo Ortiz", "Pimentel"],
                "Lambayeque": ["Lambayeque", "Mórrope"]
            },
            "Lima": {
                "Lima": [
                    "Ancón", "Ate", "Barranco", "Breña", "Carabayllo", "Chorrillos", "Comas", "El Agustino",
                    "Independencia", "Jesús María", "La Molina", "La Victoria", "Lince", "Los Olivos", "Lurigancho",
                    "Lurín", "Magdalena del Mar", "Pueblo Libre", "Miraflores", "Pachacámac", "Pucusana", "Punta Hermosa",
                    "Punta Negra", "Puente Piedra", "San Bartolo", "San Isidro", "San Juan de Lurigancho",
                    "San Juan de Miraflores", "San Luis", "San Martín de Porres", "San Miguel", "Santa Anita",
                    "Santiago de Surco", "Surquillo", "Villa El Salvador", "Villa María del Triunfo"
                ],
                "Cañete": ["Imperial", "San Vicente de Cañete"],
                "Huaura": ["Huacho", "Santa María"]
            },
            "Loreto": {
                "Maynas": ["Iquitos", "Punchana", "San Juan Bautista"]
            },
            "Madre de Dios": {
                "Tambopata": ["Puerto Maldonado", "Inambari"]
            },
            "Moquegua": {
                "Mariscal Nieto": ["Moquegua", "Samegua"]
            },
            "Pasco": {
                "Pasco": ["Chaupimarca", "Yanacancha"]
            },
            "Piura": {
                "Piura": ["Piura", "Castilla", "Veintiséis de Octubre", "Catacaos"],
                "Sullana": ["Sullana", "Bellavista"]
            },
            "Puno": {
                "Puno": ["Puno", "Acora", "Chucuito"],
                "San Román": ["Juliaca", "Caracoto"]
            },
            "San Martín": {
                "San Martín": ["Tarapoto", "La Banda de Shilcayo"]
            },
            "Tacna": {
                "Tacna": ["Tacna", "Gregorio Albarracín Lanchipa"]
            },
            "Tumbes": {
                "Tumbes": ["Tumbes", "Corrales", "Zorritos"]
            },
            "Ucayali": {
                "Coronel Portillo": ["Pucallpa", "Callería"]
            }
        };

        const serviceCategories = {
            "Transporte": ["Taxi", "Servicio de carga", "Servicio de mudanzas", "Servicio de cargas y mudanzas", "Servicio de Courier"],
            "Servicios del Hogar": ["Electricista", "Plomero", "Jardinería", "Limpieza", "Gasfitería", "Pintor"],
            "Educación": ["Clases de Matemática", "Clases de Idiomas", "Tutoría General", "Refuerzo Escolar", "Clases de Música"],
            "Belleza y Bienestar": ["Peluquería", "Manicura", "Masajes", "Yoga", "Entrenador Personal"],
            "Tecnología": ["Reparación de Computadoras", "Reparación de Celulares", "Desarrollo Web", "Soporte Técnico"],
            "Eventos y Ocio": ["Fotografía", "Catering", "Organizador de Eventos", "Músico para Fiestas"],
            "Otros": ["Consultoría", "Asesoría Legal", "Diseño Gráfico"]
        };
        
        // Elementos de la UI
        const navServicesBtn = document.getElementById('nav-services-btn');
        const navAboutBtn = document.getElementById('nav-about-btn');
        const navSupportBtn = document.getElementById('nav-support-btn');
        const addProfileBtn = document.getElementById('add-profile-btn');
        const adminPanelBtn = document.getElementById('admin-panel-btn');
        const profilesView = document.getElementById('profiles-view');
        const addProfileView = document.getElementById('add-profile-view');
        const adminView = document.getElementById('admin-view');
        const aboutUsView = document.getElementById('about-us-view');
        const supportView = document.getElementById('support-view');
        const profilesList = document.getElementById('profiles-list');
        const adminProfilesList = document.getElementById('admin-profiles-list');
        const noProfilesMessage = document.getElementById('no-profiles-message');
        const noAdminProfilesMessage = document.getElementById('no-admin-profiles-message');
        const loadingMessage = document.getElementById('loading-message');
        const userIdDisplay = document.getElementById('user-id-display');
        const addProfileForm = document.getElementById('add-profile-form');
        const backToProfilesBtn = document.getElementById('back-to-profiles-btn');
        const backToProfilesFromAdminBtn = document.getElementById('back-to-profiles-from-admin-btn');
        const modal = document.getElementById('modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalContent = document.getElementById('modal-content');
        const modalButtons = document.getElementById('modal-buttons');
        const searchInput = document.getElementById('search-input');
        const categoryFilter = document.getElementById('category-filter');
        const subcategoryFilter = document.getElementById('subcategory-filter');
        const regionFilter = document.getElementById('region-filter');
        const provinceFilter = document.getElementById('province-filter');
        const districtFilter = document.getElementById('district-filter');
        const profileCategorySelect = document.getElementById('profile-category');
        const profileSubcategorySelect = document.getElementById('profile-subcategory');
        const profileRegionSelect = document.getElementById('profile-region');
        const profileProvinceSelect = document.getElementById('profile-province');
        const profileDistrictSelect = document.getElementById('profile-district');
        const profileImageInput = document.getElementById('profile-image');
        const imagePreviewContainer = document.getElementById('image-preview');
        const previewImage = document.getElementById('preview-image');
        const uploadProgressContainer = document.getElementById('upload-progress-container');
        const uploadProgress = document.getElementById('upload-progress');
        const savingMessage = document.getElementById('saving-message');
        const saveProfileBtn = document.getElementById('save-profile-btn');

        function switchView(viewToShow, activeBtn = null) {
            // Oculta todas las vistas
            profilesView.classList.add('hidden');
            addProfileView.classList.add('hidden');
            adminView.classList.add('hidden');
            aboutUsView.classList.add('hidden');
            supportView.classList.add('hidden');

            // Muestra la vista deseada
            viewToShow.classList.remove('hidden');

            // Actualiza los botones de navegación
            const navButtons = document.querySelectorAll('.nav-btn');
            navButtons.forEach(btn => {
                btn.classList.remove('active', 'bg-blue-600', 'text-white');
                btn.classList.add('bg-gray-200', 'text-gray-800');
            });
            if (activeBtn) {
                activeBtn.classList.add('active', 'bg-blue-600', 'text-white');
                activeBtn.classList.remove('bg-gray-200', 'text-gray-800');
            }
        }

        function showModal(title, message, isConfirm = false, onConfirm = () => {}, isRate = false, profileId = null) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modalContent.innerHTML = '';
            modalButtons.innerHTML = '';

            if (isRate) {
                const ratingHtml = `
                    <div class="star-rating text-3xl flex justify-center flex-row-reverse space-x-2 space-x-reverse mb-4">
                        <input type="radio" id="star5" name="rating" value="5" /><label for="star5" title="5 estrellas"></label>
                        <input type="radio" id="star4" name="rating" value="4" /><label for="star4" title="4 estrellas"></label>
                        <input type="radio" id="star3" name="rating" value="3" /><label for="star3" title="3 estrellas"></label>
                        <input type="radio" id="star2" name="rating" value="2" /><label for="star2" title="2 estrellas"></label>
                        <input type="radio" id="star1" name="rating" value="1" /><label for="star1" title="1 estrella"></label>
                    </div>
                `;
                modalContent.innerHTML = ratingHtml;
                const rateBtn = document.createElement('button');
                rateBtn.textContent = 'Calificar';
                rateBtn.classList.add('bg-blue-600', 'text-white', 'px-4', 'py-2', 'rounded-lg', 'font-medium', 'hover:bg-blue-700', 'transition', 'duration-300');
                rateBtn.onclick = () => {
                    const rating = document.querySelector('input[name="rating"]:checked');
                    if (rating) {
                        onConfirm(parseInt(rating.value));
                        hideModal();
                    } else {
                        modalMessage.textContent = "Por favor, selecciona una calificación.";
                    }
                };
                modalButtons.appendChild(rateBtn);
                const cancelBtn = document.createElement('button');
                cancelBtn.textContent = 'Cancelar';
                cancelBtn.classList.add('bg-gray-200', 'text-gray-800', 'px-4', 'py-2', 'rounded-lg', 'font-medium', 'hover:bg-gray-300', 'transition', 'duration-300');
                cancelBtn.onclick = hideModal;
                modalButtons.appendChild(cancelBtn);
            } else {
                if (isConfirm) {
                    const okBtn = document.createElement('button');
                    okBtn.textContent = 'Aceptar';
                    okBtn.classList.add('bg-red-600', 'text-white', 'px-4', 'py-2', 'rounded-lg', 'font-medium', 'hover:bg-red-700', 'transition', 'duration-300');
                    okBtn.onclick = () => {
                        onConfirm();
                        hideModal();
                    };
                    const cancelBtn = document.createElement('button');
                    cancelBtn.textContent = 'Cancelar';
                    cancelBtn.classList.add('bg-gray-200', 'text-gray-800', 'px-4', 'py-2', 'rounded-lg', 'font-medium', 'hover:bg-gray-300', 'transition', 'duration-300');
                    cancelBtn.onclick = hideModal;
                    modalButtons.appendChild(cancelBtn);
                    modalButtons.appendChild(okBtn);
                } else {
                    const okBtn = document.createElement('button');
                    okBtn.textContent = 'Aceptar';
                    okBtn.classList.add('bg-blue-600', 'text-white', 'px-4', 'py-2', 'rounded-lg', 'font-medium', 'hover:bg-blue-700', 'transition', 'duration-300');
                    okBtn.onclick = hideModal;
                    modalButtons.appendChild(okBtn);
                }
            }

            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function hideModal() {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        function displayProfiles(profiles, container) {
            container.innerHTML = '';
            if (profiles.length === 0) {
                if (container.id === 'profiles-list') {
                    noProfilesMessage.classList.remove('hidden');
                } else {
                    noAdminProfilesMessage.classList.remove('hidden');
                }
            } else {
                noProfilesMessage.classList.add('hidden');
                noAdminProfilesMessage.classList.add('hidden');
                profiles.forEach(profile => {
                    const card = createProfileCard(profile, container.id === 'admin-profiles-list');
                    container.appendChild(card);
                });
            }
        }
        
        // Helper function to render star icons
        function getStarIcons(rating) {
            const roundedRating = Math.round(rating * 2) / 2;
            let starsHtml = '';
            for (let i = 1; i <= 5; i++) {
                if (roundedRating >= i) {
                    starsHtml += `<i class="fa-solid fa-star text-yellow-400"></i>`;
                } else if (roundedRating >= i - 0.5) {
                    starsHtml += `<i class="fa-solid fa-star-half-stroke text-yellow-400"></i>`;
                } else {
                    starsHtml += `<i class="fa-solid fa-star text-gray-300"></i>`;
                }
            }
            return starsHtml;
        }


        function createProfileCard(profile, isAdmin = false) {
            const card = document.createElement('div');
            card.className = 'bg-gray-100 rounded-lg p-4 shadow-md flex flex-col hover:shadow-xl transition-shadow duration-300';
            
            const profileImage = profile.imageURL || 'https://placehold.co/150x150/d1d5db/4b5563?text=Sin+Imagen';
            
            const ratingScore = profile.rating || 0;
            const ratingCount = profile.ratingCount || 0;
            const starIcons = getStarIcons(ratingScore);

            card.innerHTML = `
                <img src="${profileImage}" alt="Imagen de ${profile.name}" class="w-full h-40 object-cover rounded-lg mb-4">
                <h3 class="text-lg font-bold text-gray-900">${profile.name}</h3>
                <span class="text-sm font-semibold text-blue-600">${profile.category} - ${profile.subcategory}</span>
                <span class="text-sm text-gray-500 mt-1">${profile.region}, ${profile.province}, ${profile.district}</span>
                <p class="text-gray-700 mt-2 flex-grow">${profile.description}</p>
                <a href="https://wa.me/${profile.contact}" target="_blank" class="text-green-600 hover:text-green-800 font-bold mt-4 flex items-center transition duration-300">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.774a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z" />
                    </svg>
                    Contactar por WhatsApp
                </a>
                <div class="flex items-center mt-2 text-sm text-gray-600 space-x-2">
                    <span class="star-rating text-lg flex items-center space-x-1">${starIcons}</span>
                    <span class="text-gray-700 font-semibold">${ratingScore.toFixed(1)}</span>
                    <span class="text-gray-500">(${ratingCount})</span>
                </div>
            `;
            
            if (isAdmin) {
                const adminControls = document.createElement('div');
                adminControls.className = 'flex space-x-2 mt-4';
                
                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = 'Eliminar';
                deleteBtn.className = 'bg-red-500 text-white px-3 py-1 rounded-full text-sm hover:bg-red-600 transition-colors duration-300';
                deleteBtn.onclick = () => showModal(
                    'Confirmar Eliminación',
                    '¿Estás seguro de que quieres eliminar este perfil? Esta acción es irreversible.',
                    true,
                    () => deleteProfile(profile.id)
                );

                adminControls.appendChild(deleteBtn);
                card.appendChild(adminControls);
            } else {
                 const rateBtn = document.createElement('button');
                rateBtn.textContent = 'Calificar';
                rateBtn.className = 'bg-yellow-500 text-white px-3 py-1 rounded-full text-sm hover:bg-yellow-600 transition-colors duration-300 mt-2';
                rateBtn.onclick = () => showModal(
                    `Calificar a ${profile.name}`,
                    `Por favor, califica este servicio.`,
                    false,
                    (rating) => {
                        console.log(`Calificando ${profile.id} con ${rating} estrellas.`);
                        updateProfileRating(profile.id, rating);
                    },
                    true,
                    profile.id
                );

                card.appendChild(rateBtn);
            }

            return card;
        }

        function filterAndRenderProfiles() {
            const searchTerm = searchInput.value.toLowerCase();
            const selectedCategory = categoryFilter.value;
            const selectedSubcategory = subcategoryFilter.value;
            const selectedRegion = regionFilter.value;
            const selectedProvince = provinceFilter.value;
            const selectedDistrict = districtFilter.value;

            const filteredProfiles = allProfiles.filter(profile => {
                const matchesSearch = profile.name.toLowerCase().includes(searchTerm) || profile.description.toLowerCase().includes(searchTerm);
                const matchesCategory = selectedCategory === 'all' || profile.category === selectedCategory;
                const matchesSubcategory = selectedSubcategory === 'all' || profile.subcategory === selectedSubcategory;
                const matchesRegion = selectedRegion === 'all' || profile.region === selectedRegion;
                const matchesProvince = selectedProvince === 'all' || profile.province === selectedProvince;
                const matchesDistrict = selectedDistrict === 'all' || profile.district === selectedDistrict;

                return matchesSearch && matchesCategory && matchesSubcategory && matchesRegion && matchesProvince && matchesDistrict;
            });

            displayProfiles(filteredProfiles, profilesList);
        }

        function populateCategoryFilters() {
            for (const category in serviceCategories) {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                categoryFilter.appendChild(option.cloneNode(true));
                profileCategorySelect.appendChild(option);
            }
        }

        function populateSubcategoryFilters(category) {
            const subcategories = serviceCategories[category] || [];
            subcategoryFilter.innerHTML = '<option value="all">Todas las subcategorías</option>';
            profileSubcategorySelect.innerHTML = '<option value="">Selecciona una subcategoría...</option>';
            subcategories.forEach(sub => {
                const option = document.createElement('option');
                option.value = sub;
                option.textContent = sub;
                subcategoryFilter.appendChild(option.cloneNode(true));
                profileSubcategorySelect.appendChild(option);
            });
        }
        
        function populateRegionFilters() {
            for (const region in peruLocations) {
                const option = document.createElement('option');
                option.value = region;
                option.textContent = region;
                regionFilter.appendChild(option.cloneNode(true));
                profileRegionSelect.appendChild(option);
            }
        }

        function populateProvinceFilters(region) {
            const provinces = peruLocations[region] ? Object.keys(peruLocations[region]) : [];
            provinceFilter.innerHTML = '<option value="all">Todas las Provincias</option>';
            profileProvinceSelect.innerHTML = '<option value="">Selecciona una Provincia...</option>';
            provinces.forEach(province => {
                const option = document.createElement('option');
                option.value = province;
                option.textContent = province;
                provinceFilter.appendChild(option.cloneNode(true));
                profileProvinceSelect.appendChild(option);
            });
        }

        function populateDistrictFilters(region, province) {
            const districts = peruLocations[region] ? peruLocations[region][province] || [] : [];
            districtFilter.innerHTML = '<option value="all">Todos los Distritos</option>';
            profileDistrictSelect.innerHTML = '<option value="">Selecciona un Distrito...</option>';
            districts.forEach(district => {
                const option = document.createElement('option');
                option.value = district;
                option.textContent = district;
                profileDistrictSelect.appendChild(option);
            });
        }

        // Firebase Firestore & Storage
        async function getProfiles() {
            loadingMessage.classList.remove('hidden');
            const profilesColRef = collection(db, `artifacts/${appId}/public/data/profiles`);
            
            onSnapshot(profilesColRef, (snapshot) => {
                loadingMessage.classList.add('hidden');
                const profiles = [];
                snapshot.forEach(doc => {
                    profiles.push({ id: doc.id, ...doc.data() });
                });
                allProfiles = profiles;
                filterAndRenderProfiles();
                if (adminView.classList.contains('flex')) {
                    displayProfiles(allProfiles, adminProfilesList);
                }
            }, (error) => {
                console.error("Error al obtener perfiles: ", error);
                loadingMessage.classList.add('hidden');
                showModal('Error', 'No se pudieron cargar los perfiles. Inténtalo de nuevo más tarde.');
            });
        }

        async function addProfile(profileData, imageFile) {
            savingMessage.classList.remove('hidden');
            saveProfileBtn.disabled = true;
            try {
                let imageURL = '';
                if (imageFile) {
                    const storageRef = ref(storage, `profiles/${userId}/${imageFile.name}`);
                    const uploadTask = uploadBytesResumable(storageRef, imageFile);
                    
                    uploadProgressContainer.classList.remove('hidden');

                    uploadTask.on('state_changed',
                        (snapshot) => {
                            const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                            uploadProgress.style.width = `${progress}%`;
                        }, 
                        (error) => {
                            console.error("Error al subir la imagen: ", error);
                            showModal('Error de Carga', 'Hubo un problema al subir la imagen.');
                        }, 
                        async () => {
                            imageURL = await getDownloadURL(uploadTask.snapshot.ref);
                            // Ahora, guarda el perfil con la URL de la imagen
                            const profilesColRef = collection(db, `artifacts/${appId}/public/data/profiles`);
                            await addDoc(profilesColRef, {
                                ...profileData,
                                imageURL: imageURL,
                                ownerId: userId,
                                createdAt: new Date(),
                                rating: 0,
                                ratingCount: 0,
                                ratings: {}
                            });
                            
                            showModal('Éxito', 'Tu perfil de servicio se ha agregado correctamente.');
                            addProfileForm.reset();
                            switchView(profilesView, navServicesBtn);
                            savingMessage.classList.add('hidden');
                            saveProfileBtn.disabled = false;
                        }
                    );
                } else {
                    const profilesColRef = collection(db, `artifacts/${appId}/public/data/profiles`);
                    await addDoc(profilesColRef, {
                        ...profileData,
                        imageURL: '',
                        ownerId: userId,
                        createdAt: new Date(),
                        rating: 0,
                        ratingCount: 0,
                        ratings: {}
                    });
                    
                    showModal('Éxito', 'Tu perfil de servicio se ha agregado correctamente.');
                    addProfileForm.reset();
                    switchView(profilesView, navServicesBtn);
                    savingMessage.classList.add('hidden');
                    saveProfileBtn.disabled = false;
                }
            } catch (e) {
                console.error("Error al agregar el perfil: ", e);
                showModal('Error', 'Hubo un problema al guardar el perfil. Inténtalo de nuevo.');
                savingMessage.classList.add('hidden');
                saveProfileBtn.disabled = false;
            } finally {
                uploadProgressContainer.classList.add('hidden');
                uploadProgress.style.width = '0%';
            }
        }

        async function updateProfileRating(profileId, rating) {
            try {
                const profileRef = doc(db, `artifacts/${appId}/public/data/profiles`, profileId);
                const profileSnap = await getDoc(profileRef);
                const profileData = profileSnap.data();
                
                // Obtenemos las calificaciones existentes
                const ratings = profileData.ratings || {};
                
                // Actualizamos la calificación del usuario actual
                ratings[userId] = rating;

                // Calculamos el nuevo promedio y el conteo
                const newRatingCount = Object.keys(ratings).length;
                const newRatingSum = Object.values(ratings).reduce((sum, val) => sum + val, 0);
                const newRating = (newRatingSum / newRatingCount).toFixed(1);
                
                await updateDoc(profileRef, {
                    ratings: ratings,
                    rating: parseFloat(newRating),
                    ratingCount: newRatingCount
                });

                showModal('Calificación Exitosa', '¡Gracias por calificar este servicio!');
            } catch (e) {
                console.error("Error al calificar el perfil: ", e);
                showModal('Error', 'Hubo un problema al guardar tu calificación. Inténtalo de nuevo.');
            }
        }
        
        async function deleteProfile(profileId) {
            try {
                const profileRef = doc(db, `artifacts/${appId}/public/data/profiles`, profileId);
                await deleteDoc(profileRef);
                showModal('Eliminado', 'El perfil se ha eliminado correctamente.');
            } catch (e) {
                console.error("Error al eliminar el perfil: ", e);
                showModal('Error', 'Hubo un problema al eliminar el perfil.');
            }
        }

        // Event Listeners
        window.onload = function() {
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                storage = getStorage(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdDisplay.textContent = `ID de usuario: ${userId}`;
                        getProfiles();
                    } else {
                        try {
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } else {
                                await signInAnonymously(auth);
                            }
                        } catch (error) {
                            console.error("Error during authentication: ", error);
                            userIdDisplay.textContent = 'Error de autenticación';
                        }
                    }
                });
            } catch (e) {
                console.error("Error al inicializar Firebase: ", e);
                showModal('Error de Inicialización', 'No se pudo conectar a los servicios de la aplicación. Por favor, recarga la página.');
            }

            populateCategoryFilters();
            populateRegionFilters();
            switchView(profilesView, navServicesBtn);

            navServicesBtn.addEventListener('click', () => switchView(profilesView, navServicesBtn));
            navAboutBtn.addEventListener('click', () => switchView(aboutUsView, navAboutBtn));
            navSupportBtn.addEventListener('click', () => switchView(supportView, navSupportBtn));
            addProfileBtn.addEventListener('click', () => switchView(addProfileView));
            adminPanelBtn.addEventListener('click', () => {
                switchView(adminView);
                displayProfiles(allProfiles, adminProfilesList);
            });
            backToProfilesBtn.addEventListener('click', () => switchView(profilesView, navServicesBtn));
            backToProfilesFromAdminBtn.addEventListener('click', () => switchView(profilesView, navServicesBtn));
            
            searchInput.addEventListener('input', filterAndRenderProfiles);
            categoryFilter.addEventListener('change', (e) => {
                populateSubcategoryFilters(e.target.value);
                filterAndRenderProfiles();
            });
            subcategoryFilter.addEventListener('change', filterAndRenderProfiles);
            regionFilter.addEventListener('change', (e) => {
                populateProvinceFilters(e.target.value);
                populateDistrictFilters(e.target.value, '');
                filterAndRenderProfiles();
            });
            provinceFilter.addEventListener('change', (e) => {
                populateDistrictFilters(regionFilter.value, e.target.value);
                filterAndRenderProfiles();
            });
            districtFilter.addEventListener('change', filterAndRenderProfiles);
            
            profileCategorySelect.addEventListener('change', (e) => populateSubcategorySelect(e.target.value));
            profileRegionSelect.addEventListener('change', (e) => populateProvinceSelect(e.target.value));
            profileProvinceSelect.addEventListener('change', (e) => populateDistrictSelect(profileRegionSelect.value, e.target.value));

            profileImageInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        previewImage.src = event.target.result;
                        imagePreviewContainer.classList.remove('hidden');
                    };
                    reader.readAsDataURL(file);
                } else {
                    imagePreviewContainer.classList.add('hidden');
                    previewImage.src = '';
                }
            });

            addProfileForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const name = document.getElementById('profile-name').value;
                const category = document.getElementById('profile-category').value;
                const subcategory = document.getElementById('profile-subcategory').value;
                const description = document.getElementById('profile-description').value;
                const region = document.getElementById('profile-region').value;
                const province = document.getElementById('profile-province').value;
                const district = document.getElementById('profile-district').value;
                const contact = document.getElementById('profile-contact').value;
                const imageFile = profileImageInput.files[0];

                const profileData = { name, category, subcategory, description, region, province, district, contact };

                await addProfile(profileData, imageFile);
            });
        };

        function populateSubcategorySelect(category) {
            profileSubcategorySelect.innerHTML = '<option value="">Selecciona una subcategoría...</option>';
            const subcategories = serviceCategories[category] || [];
            subcategories.forEach(sub => {
                const option = document.createElement('option');
                option.value = sub;
                option.textContent = sub;
                profileSubcategorySelect.appendChild(option);
            });
        }
        
        function populateProvinceSelect(region) {
            profileProvinceSelect.innerHTML = '<option value="">Selecciona una Provincia...</option>';
            const provinces = peruLocations[region] ? Object.keys(peruLocations[region]) : [];
            provinces.forEach(province => {
                const option = document.createElement('option');
                option.value = province;
                option.textContent = province;
                profileProvinceSelect.appendChild(option);
            });
        }

        function populateDistrictSelect(region, province) {
            profileDistrictSelect.innerHTML = '<option value="">Selecciona un Distrito...</option>';
            const districts = peruLocations[region] ? peruLocations[region][province] || [] : [];
            districts.forEach(district => {
                const option = document.createElement('option');
                option.value = district;
                option.textContent = district;
                profileDistrictSelect.appendChild(option);
            });
        }
    </script>
</body>
</html>
